<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Adaptation System</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5em;
            color: #2E7D32;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.2em;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #2E7D32;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
        }
        
        .btn:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #2196F3;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #1976D2;
        }
        
        .results-section {
            grid-column: 1 / -1;
            margin-top: 20px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .result-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .result-card h3 {
            color: #2E7D32;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .crop-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin: 8px 0;
            border-left: 4px solid #4CAF50;
        }
        
        .scheme-item {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 6px;
            margin: 8px 0;
            border-left: 4px solid #2196F3;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .farm-layout {
            margin-top: 20px;
            text-align: center;
        }
        
        .farm-layout svg {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .nearby-farms {
            margin-top: 20px;
        }
        
        .nearby-farm-item {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #FF9800;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // API Configuration
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:8001' 
            : window.location.origin;

        // Main App Component
        function ClimateAdaptationApp() {
            const [formData, setFormData] = useState({
                location: '',
                farm_size: '',
                soil_type: '',
                water_source: '',
                current_crops: [],
                budget: '',
                experience_level: '',
                climate_concerns: [],
                adaptation_goals: []
            });
            
            const [results, setResults] = useState(null);
            const [nearbyFarms, setNearbyFarms] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleInputChange = (field, value) => {
                setFormData(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            const handleArrayChange = (field, value) => {
                const values = value.split(',').map(v => v.trim()).filter(v => v);
                setFormData(prev => ({
                    ...prev,
                    [field]: values
                }));
            };

            const submitForm = async () => {
                if (!formData.location || !formData.farm_size) {
                    setError('Please fill in location and farm size');
                    return;
                }

                setLoading(true);
                setError('');

                try {
                    const response = await fetch(`${API_BASE}/analyze-climate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            farm_details: {
                                location: formData.location,
                                farm_size: parseFloat(formData.farm_size),
                                soil_type: formData.soil_type,
                                water_source: formData.water_source,
                                current_crops: formData.current_crops,
                                budget: parseFloat(formData.budget) || 0,
                                experience_level: formData.experience_level
                            },
                            climate_concerns: formData.climate_concerns,
                            adaptation_goals: formData.adaptation_goals
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    setResults(data.adaptation_plan);
                    
                    // Also fetch nearby farms
                    fetchNearbyFarms();
                    
                } catch (err) {
                    setError(`Analysis failed: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const fetchNearbyFarms = async () => {
                try {
                    const response = await fetch(`${API_BASE}/nearby-farms`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            location: formData.location,
                            radius_km: 10
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        setNearbyFarms(data.nearby_plans || []);
                    }
                } catch (err) {
                    console.error('Failed to fetch nearby farms:', err);
                }
            };

            return (
                <div className="container">
                    <div className="header">
                        <h1>üå± Climate Adaptation System</h1>
                        <p>AI-Powered Climate Resilient Agriculture Planning for Farmers</p>
                    </div>

                    <div className="main-content">
                        <ClimateForm 
                            formData={formData}
                            onInputChange={handleInputChange}
                            onArrayChange={handleArrayChange}
                            onSubmit={submitForm}
                            loading={loading}
                            error={error}
                        />
                        
                        <NearbyFarms farms={nearbyFarms} />
                    </div>

                    {results && (
                        <div className="results-section">
                            <ResultsDisplay results={results} />
                        </div>
                    )}
                </div>
            );
        }

        // Climate Form Component
        function ClimateForm({ formData, onInputChange, onArrayChange, onSubmit, loading, error }) {
            return (
                <div className="card">
                    <h2>üè° Farm Details & Climate Concerns</h2>
                    
                    <div className="form-group">
                        <div className="form-row">
                            <div>
                                <label>Location (City, State)</label>
                                <input
                                    type="text"
                                    value={formData.location}
                                    onChange={(e) => onInputChange('location', e.target.value)}
                                    placeholder="e.g., Pune, Maharashtra"
                                />
                            </div>
                            <div>
                                <label>Farm Size (acres)</label>
                                <input
                                    type="number"
                                    value={formData.farm_size}
                                    onChange={(e) => onInputChange('farm_size', e.target.value)}
                                    placeholder="e.g., 5"
                                />
                            </div>
                        </div>
                    </div>

                    <div className="form-group">
                        <div className="form-row">
                            <div>
                                <label>Soil Type</label>
                                <select
                                    value={formData.soil_type}
                                    onChange={(e) => onInputChange('soil_type', e.target.value)}
                                >
                                    <option value="">Select soil type</option>
                                    <option value="clay">Clay</option>
                                    <option value="loamy">Loamy</option>
                                    <option value="sandy">Sandy</option>
                                    <option value="black">Black Cotton</option>
                                    <option value="red">Red</option>
                                </select>
                            </div>
                            <div>
                                <label>Water Source</label>
                                <select
                                    value={formData.water_source}
                                    onChange={(e) => onInputChange('water_source', e.target.value)}
                                >
                                    <option value="">Select water source</option>
                                    <option value="borewell">Borewell</option>
                                    <option value="well">Open Well</option>
                                    <option value="river">River/Canal</option>
                                    <option value="rainwater">Rainwater</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div className="form-group">
                        <div className="form-row">
                            <div>
                                <label>Budget (‚Çπ)</label>
                                <input
                                    type="number"
                                    value={formData.budget}
                                    onChange={(e) => onInputChange('budget', e.target.value)}
                                    placeholder="e.g., 100000"
                                />
                            </div>
                            <div>
                                <label>Experience Level</label>
                                <select
                                    value={formData.experience_level}
                                    onChange={(e) => onInputChange('experience_level', e.target.value)}
                                >
                                    <option value="">Select experience</option>
                                    <option value="beginner">Beginner (0-2 years)</option>
                                    <option value="intermediate">Intermediate (3-10 years)</option>
                                    <option value="experienced">Experienced (10+ years)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div className="form-group">
                        <label>Current Crops (comma-separated)</label>
                        <input
                            type="text"
                            value={formData.current_crops.join(', ')}
                            onChange={(e) => onArrayChange('current_crops', e.target.value)}
                            placeholder="e.g., rice, wheat, cotton"
                        />
                    </div>

                    <div className="form-group">
                        <label>Climate Concerns (comma-separated)</label>
                        <input
                            type="text"
                            value={formData.climate_concerns.join(', ')}
                            onChange={(e) => onArrayChange('climate_concerns', e.target.value)}
                            placeholder="e.g., drought, irregular rainfall, heat waves"
                        />
                    </div>

                    <div className="form-group">
                        <label>Adaptation Goals (comma-separated)</label>
                        <input
                            type="text"
                            value={formData.adaptation_goals.join(', ')}
                            onChange={(e) => onArrayChange('adaptation_goals', e.target.value)}
                            placeholder="e.g., increase yield, reduce water usage, improve soil health"
                        />
                    </div>

                    {error && (
                        <div style={{color: 'red', marginBottom: '15px', padding: '10px', background: '#ffebee', borderRadius: '4px'}}>
                            {error}
                        </div>
                    )}

                    <button 
                        className="btn" 
                        onClick={onSubmit} 
                        disabled={loading}
                    >
                        {loading ? 'Analyzing...' : 'üîç Generate Climate Adaptation Plan'}
                    </button>
                </div>
            );
        }

        // Nearby Farms Component
        function NearbyFarms({ farms }) {
            if (farms.length === 0) {
                return (
                    <div className="card">
                        <h2>üèòÔ∏è Nearby Farm Plans</h2>
                        <p style={{color: '#666', textAlign: 'center', padding: '20px'}}>
                            Submit your farm details to see adaptation plans from nearby farms
                        </p>
                    </div>
                );
            }

            return (
                <div className="card">
                    <h2>üèòÔ∏è Nearby Farm Plans ({farms.length})</h2>
                    <div className="nearby-farms">
                        {farms.map((farm, index) => (
                            <div key={index} className="nearby-farm-item">
                                <strong>{farm.location}</strong> - {farm.farm_size} acres
                                <br />
                                <small>Soil: {farm.soil_type} | Crops: {farm.recommended_crops?.join(', ')}</small>
                                <br />
                                <small style={{color: '#4CAF50'}}>‚úÖ {farm.success_metrics?.climate_resilience} resilience</small>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // Results Display Component
        function ResultsDisplay({ results }) {
            if (!results) return null;

            return (
                <div className="card">
                    <h2>üìä Climate Adaptation Plan Results</h2>
                    
                    {results.climate_analysis && (
                        <div className="loading">
                            <div className="spinner"></div>
                            <p>Generating comprehensive climate adaptation plan...</p>
                        </div>
                    )}

                    <div className="results-grid">
                        {/* Climate Analysis */}
                        {results.climate_analysis && (
                            <div className="result-card">
                                <h3>üå°Ô∏è Climate Risk Analysis</h3>
                                <div>
                                    <strong>Identified Risks:</strong>
                                    {results.climate_analysis.risks?.map((risk, index) => (
                                        <div key={index} className="crop-item">
                                            {risk.replace('_', ' ').toUpperCase()}
                                        </div>
                                    ))}
                                </div>
                                <div style={{marginTop: '10px'}}>
                                    <strong>Urgency Level:</strong> 
                                    <span style={{color: results.climate_analysis.urgency_level === 'High' ? 'red' : 'orange'}}>
                                        {results.climate_analysis.urgency_level}
                                    </span>
                                </div>
                            </div>
                        )}

                        {/* Crop Recommendations */}
                        {results.crop_recommendations && (
                            <div className="result-card">
                                <h3>üåæ Recommended Crops</h3>
                                {results.crop_recommendations.recommended_crops?.map((crop, index) => (
                                    <div key={index} className="crop-item">
                                        <strong>{crop}</strong>
                                        <br />
                                        <small>Climate resilient ‚Ä¢ High yield potential</small>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Government Schemes */}
                        {results.government_schemes && (
                            <div className="result-card">
                                <h3>üèõÔ∏è Government Schemes</h3>
                                {results.government_schemes.recommended_schemes?.map((scheme, index) => (
                                    <div key={index} className="scheme-item">
                                        <strong>{scheme.name}</strong>
                                        <br />
                                        <small>Subsidy: ‚Çπ{scheme.subsidy?.amount?.toLocaleString()}</small>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Market Analysis */}
                        {results.market_analysis && (
                            <div className="result-card">
                                <h3>üìà Market Analysis</h3>
                                <div>
                                    <strong>Market Insights:</strong>
                                    {results.market_analysis.market_insights?.map((insight, index) => (
                                        <div key={index} style={{margin: '5px 0', fontSize: '0.9em'}}>
                                            ‚Ä¢ {insight}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Implementation Timeline */}
                        {results.implementation_timeline && (
                            <div className="result-card">
                                <h3>üìÖ Implementation Timeline</h3>
                                {results.implementation_timeline.map((phase, index) => (
                                    <div key={index} style={{marginBottom: '15px'}}>
                                        <strong>{phase.phase}</strong>
                                        <ul style={{marginLeft: '20px', marginTop: '5px'}}>
                                            {phase.actions?.map((action, actionIndex) => (
                                                <li key={actionIndex} style={{fontSize: '0.9em', margin: '3px 0'}}>
                                                    {action}
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Cost Analysis */}
                        {results.estimated_costs && (
                            <div className="result-card">
                                <h3>üí∞ Cost Analysis</h3>
                                <div>
                                    <div><strong>Total Cost:</strong> ‚Çπ{results.estimated_costs.total_estimated_cost?.toLocaleString()}</div>
                                    <div><strong>Government Subsidy:</strong> ‚Çπ{results.estimated_costs.government_subsidy?.toLocaleString()}</div>
                                    <div><strong>Your Contribution:</strong> ‚Çπ{results.estimated_costs.farmer_contribution?.toLocaleString()}</div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Farm Layout SVG */}
                    {results.farm_layout_svg && (
                        <div className="farm-layout">
                            <h3>üó∫Ô∏è Recommended Farm Layout</h3>
                            <div dangerouslySetInnerHTML={{__html: results.farm_layout_svg}} />
                        </div>
                    )}
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<ClimateAdaptationApp />, document.getElementById('root'));
    </script>
</body>
</html>